#=====================================================================
#
# Toplevel makefile for OMNeT++ libraries and programs
#
# platform: Windows 95/98/ME
# compiler: MSVC 6.0
#
#=====================================================================

#
# Under Win98 one should run vcvars32.bat before executing an nmake command.
# If you getting "out of enviroment space" errors, include this line in
# your Config.sys:
#   COMSPEC=C:\WINDOWS\COMMAND.COM /E=2048
# And into your autoexec.bat:
#   Call VCVARS32.BAT
#


#
# Options
#
include configuser.vc

MOPTS=/nologo
MAKEFILE=/F Makefile.vc

# envir_ilib only needed if dlls are to be built
!if "$(LIB_SUFFIX)"==".dll"
ENVIR_ILIB=envir_ilib
!else
ENVIR_ILIB=
!endif


#=====================================================================
#
# Main targets
#
#=====================================================================


all: check-env components reminder

components: libs progs configsamples samples configtutorial tutorial


#=====================================================================
#
# OMNeT++ components
#
#=====================================================================

LIBS=$(ENVIR_ILIB) sim envir cmdenv tkenv
PROGS=utils nedc gned plove
SAMPLES=dyna fddi fifo1 fifo2 hcube hist nim pvmex token demo

#
# Group targets. Note that utils has to be built BEFORE other libs and progs.
#
libs: utils $(LIBS)
progs: $(PROGS)
samples: $(SAMPLES)


#
# Libraries
#

envir_ilib:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SRC_DIR:/=\)\envir
	$(MAKE) $(MOPTS) $(MAKEFILE) envir.ilib

sim:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SRC_DIR:/=\)\sim
	$(MAKE) $(MOPTS) $(MAKEFILE)

envir:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SRC_DIR:/=\)\envir
	$(MAKE) $(MOPTS) $(MAKEFILE)

cmdenv:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SRC_DIR:/=\)\cmdenv
	$(MAKE) $(MOPTS) $(MAKEFILE)

tkenv:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SRC_DIR:/=\)\tkenv
	$(MAKE) $(MOPTS) $(MAKEFILE)

#
# Programs
#

nedc:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SRC_DIR:/=\)\nedc
	$(MAKE) $(MOPTS) $(MAKEFILE)

gned:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SRC_DIR:/=\)\gned
	$(MAKE) $(MOPTS) $(MAKEFILE)

plove:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SRC_DIR:/=\)\plove
	$(MAKE) $(MOPTS) $(MAKEFILE)

utils:
	@echo ===== Compiling $@ ====
	echo @$(WISH:/=\) -f $(OMNETPP_ROOT)/bitmaps/showpics > $(OMNETPP_ROOT:/=\)\bitmaps\showpics.bat
	cd $(OMNETPP_SRC_DIR:/=\)\utils
	 $(MAKE) $(MOPTS) $(MAKEFILE)

#
# Sample programs
#

dyna:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\dyna
	$(MAKE) $(MOPTS) -f $@.mak

fddi:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\fddi
	$(MAKE) $(MOPTS) -f $@.mak

fifo1:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\fifo1
	$(MAKE) $(MOPTS) -f $@.mak

fifo2:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\fifo2
	$(MAKE) $(MOPTS) -f $@.mak

hcube:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\hcube
	$(MAKE) $(MOPTS) -f $@.mak

hist:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\hist
	$(MAKE) $(MOPTS) -f $@.mak

nim:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\nim
	$(MAKE) $(MOPTS) -f $@.mak

pvmex:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\pvmex
	$(MAKE) $(MOPTS) -f $@.mak

token:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_SAMPLES_DIR:/=\)\token
	$(MAKE) $(MOPTS) -f $@.mak

demo:
	@echo ===== Compiling $@ ====
	echo @$(WISH:/=\) -f $(OMNETPP_SAMPLES_DIR)/demo/rundemo > $(OMNETPP_SAMPLES_DIR:/=\)\demo\rundemo.bat
	cd $(OMNETPP_SAMPLES_DIR:/=\)\demo
	$(MAKE) $(MOPTS) $(MAKEFILE)

tutorial:
	@echo ===== Compiling $@ ====
	cd $(OMNETPP_TUTORIAL_DIR:/=\)\queues && $(MAKE) $(MOPTS) -f queues.mak

#=====================================================================
#
# Utilities
#
#=====================================================================


check-env:
	@echo ===== Checking environment =====
	@echo  Checking if $(CXX) works...
	if not EXIST %MSVCDIR%\BIN\$(CXX) pause "PRESS CONTROL+C TWICE, $(CXX) does not exist. View this makefile for details."
	@echo Checking if OMNETPP_ROOT is correctly set...
	cd $(OMNETPP_ROOT:/=\)
	cd
	@echo Checking if TCL_LIB/TCL_VER is correctly set...
	cd $(_TCL_LIBRARY:/=\)
	cd
	@ echo "IF YOU SAW ANY ERRORS, PRESS CONTROL+C TWICE"

configsamples:
	@echo ===== Configuring .dsp and .mak files for samples =====
	cd $(OMNETPP_SAMPLES_DIR:/=\)
	cc2cpp.bat
	type << > configsample.bat
@rem *** This file was generated by Makefile.98 -- edits will be lost
cd $(OMNETPP_SAMPLES_DIR:/=\)\%1
$(REPLACE:/=\) %1.dsp.in - "@OMNETPP_INCL_DIR@" "$(OMNETPP_INCL_DIR)" | $(REPLACE:/=\) - - "@OMNETPP_LIB_DIR@" "$(OMNETPP_LIB_DIR)" | $(REPLACE:/=\) - - "@OMNETPP_BIN_DIR@" "$(OMNETPP_BIN_DIR:/=\)" | $(REPLACE:/=\) - - "@TK_LIB_PATH@" "$(TK_LIB_DIR)" | $(REPLACE:/=\) - - "@TCL_LIB@" "$(TCL_LIB)" | $(REPLACE:/=\) - %1.dsp "@TK_LIB@" "$(TK_LIB)"
$(REPLACE:/=\) %1.mak.in - "@OMNETPP_INCL_DIR@" "$(OMNETPP_INCL_DIR)" | $(REPLACE:/=\) - - "@OMNETPP_LIB_DIR@" "$(OMNETPP_LIB_DIR)" | $(REPLACE:/=\) - - "@OMNETPP_BIN_DIR@" "$(OMNETPP_BIN_DIR:/=\)" | $(REPLACE:/=\) - - "@TK_LIB_PATH@" "$(TK_LIB_DIR)" | $(REPLACE:/=\) - - "@TCL_LIB@" "$(TCL_LIB)" | $(REPLACE:/=\) - %1.mak "@TK_LIB@" "$(TK_LIB)"
cd $(OMNETPP_SAMPLES_DIR:/=\)
<<
	for %%i in ( $(SAMPLES) ) do call configsample.bat %%i

configtutorial:
	@echo ===== Configuring .dsp and .mak files for samples =====
	cd $(OMNETPP_TUTORIAL_DIR:/=\)\queues
	-ren *.cc *.cpp
	type << > configsample.bat
@rem *** This file was generated by Makefile.98 -- edits will be lost
$(REPLACE:/=\) %1.dsp.in - "@OMNETPP_INCL_DIR@" "$(OMNETPP_INCL_DIR)" | $(REPLACE:/=\) - - "@OMNETPP_LIB_DIR@" "$(OMNETPP_LIB_DIR)" | $(REPLACE:/=\) - - "@OMNETPP_BIN_DIR@" "$(OMNETPP_BIN_DIR:/=\)" | $(REPLACE:/=\) - - "@TK_LIB_PATH@" "$(TK_LIB_DIR)" | $(REPLACE:/=\) - - "@TCL_LIB@" "$(TCL_LIB)" | $(REPLACE:/=\) - %1.dsp "@TK_LIB@" "$(TK_LIB)"
$(REPLACE:/=\) %1.mak.in - "@OMNETPP_INCL_DIR@" "$(OMNETPP_INCL_DIR)" | $(REPLACE:/=\) - - "@OMNETPP_LIB_DIR@" "$(OMNETPP_LIB_DIR)" | $(REPLACE:/=\) - - "@OMNETPP_BIN_DIR@" "$(OMNETPP_BIN_DIR:/=\)" | $(REPLACE:/=\) - - "@TK_LIB_PATH@" "$(TK_LIB_DIR)" | $(REPLACE:/=\) - - "@TCL_LIB@" "$(TCL_LIB)" | $(REPLACE:/=\) - %1.mak "@TK_LIB@" "$(TK_LIB)"
<<
	call configsample.bat queues

clean:
	-for %%i in ( $(LIBS) $(PROGS) ) do \
	    cd $(OMNETPP_SRC_DIR:/=\)\%%i
	$(MAKE) $(MOPTS) $(MAKEFILE) clean
	-del /q $(OMNETPP_BIN_DIR:/=\)\*.exe
	-del /q $(OMNETPP_BIN_DIR:/=\)\*.bat
	-del /q $(OMNETPP_LIB_DIR:/=\)\*.lib
	-del /q $(OMNETPP_LIB_DIR:/=\)\*.dll
	-del /q $(OMNETPP_LIB_DIR:/=\)\*.ilib
	-for %%i in ( $(SAMPLES) ) do del $(OMNETPP_SAMPLES_DIR:/=\)\%%i\*.obj $(OMNETPP_SAMPLES_DIR:/=\)\%%i\*.exe

depend:
	for %%i in ( $(LIBS) $(PROGS) ) do \
	    cd $(OMNETPP_SRC_DIR:/=\)\%%i
	$(MAKE) $(MOPTS) $(MAKEFILE) depend
	@echo *** dependencies for samples must be done by exporting makefiles from the IDE!

reminder:
!IF "$(TCL_LIBRARY)" == ""
	@echo ***
	@echo *** Don't forget to set the TCL_LIBRARY environment variable!
	@echo *** TCL_LIBRARY=$(_TCL_LIBRARY)
	@echo ***
!ENDIF

