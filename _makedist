#
# make OMNeT++ distribution
#

if [ ! -f configure.in ]; then
    echo Must be called in top-level omnetpp dir!!!
    exit
fi

# version must be the same here and in configure.in!
version=`cat Version | sed 's/omnetpp-//'`

if test -f Makefile; then
	echo Start with a clean page by doing 'cvs checkout omnetpp'!!!
        exit 1
fi

if test ! -f doc/usman.pdf; then
	echo You forgot to copy 'usman.pdf' to doc/!!!
        exit 1
fi

cat <<END
REMINDER:
 - version number must be updated in:
     - Version, configuser.vc
     - sim: defs.h (OMNETPP_VERSION)
     - nedc: jar.c (NEDC_VERSION, NEDC_VERSION_HEX)
     - tkenv: menuproc.tcl (about box)
     - gned: gned.tcl (startup banner), and menuproc.tcl (about box)
     - plove: plove.tcl (startup banner)
     - prephtml.pl
 - you must have run '_tag' already.
 - make sure configure.user and configuser.vc contain the right CFLAGS
   (must be *release* flags!)
Press Enter if all this is OK!
END
read

rm -rf `find . -name CVS -type d`

./_setperm
autoconf

# regenerate samples' makefiles and all dependencies
./configure

(cd bin; ln -s ../src/utils/makemake .)
for i in samples/*; do
	(cd $i; make re-makemake; make re-makemake-m; make depend; rm Makefile)
done
for i in sim/*; do
	if test -f $i/Makefile.in; then
		(cd $i; make depend; rm Makefile)
	fi
done
rm bin/makemake

# touch shipped generated files
touch src/nedc/ebnf.tab.c src/nedc/ebnf.tab.h \
      src/gned/ebnf.tab.c src/gned/ebnf.tab.h

# convert LF to CR/LF in MSVC project files
for i in `find . -name '*.dsp' -o -name '*.dsw'`; do
	sed 's/$/
/' $i > $i.new && mv $i.new $i
done

# cleanup
rm _setperm
rm _tag
rm _makedist
rm _makedemo
rm _tounix
rm rpm-*
rm -rf _icons
rm -rf test
rm config.*
rm -rf src/gned/icons
rm -f doc/usman.doc
rm -rf `find . -name Makefile`
rm -rf `find . -name '*.bak'`

# pack
cd ..
mv omnetpp omnetpp-$version
tar cvfz omnetpp-$version.tgz omnetpp-$version

