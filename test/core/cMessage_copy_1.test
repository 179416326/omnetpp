%description:
Tests copying of cMessage by op=, dup(), copy ctor().

TODO: check copying of param array too

%global:
#include <string.h>

%activity:

#define CHECK(cond)  if (!(cond)) {throw cRuntimeError("BUG at line %d, failed condition %s", __LINE__, #cond);}

cMessage *msg = new cMessage("msg");
int dummy;

msg->setKind(10);
msg->setPriority(3);
msg->setBitLength(456);
msg->setBitError(true);
msg->setTimestamp(2.434);
msg->setContextPointer(&dummy);

cMessage *copies[3];
copies[0] = new cMessage(*msg);

copies[1] = (cMessage *) msg->dup();

copies[2] = new cMessage();
copies[2]->setName(msg->getName()); // op= doesn't copy name string
*copies[2] = *msg;

for (int i=0; i<3; i++)
{
    ev << i << endl;
    cMessage *cc = copies[i];

    CHECK(!strcmp(cc->getName(), msg->getName()));
    CHECK(cc->getKind()==msg->getKind());
    CHECK(cc->getPriority()==msg->getPriority());
    CHECK(cc->length()==msg->getBitLength());
    CHECK(cc->hasBitError()==msg->hasBitError());
    CHECK(cc->getTimestamp()==msg->getTimestamp());
    CHECK(cc->getContextPointer()==msg->getContextPointer());

    delete cc;
}

ev << "OK!\n";

%contains: stdout
OK!

%not-contains: stdout
BUG

