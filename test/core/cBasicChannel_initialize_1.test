%description:
Test that when simple modules get stage==0 initialized, channels are already
initialized.

%file: {}.ned

channel {MyConn}
    delay 1;
    datarate 1000;
endchannel

simple {Node1}
    gates:
        out: out;
endsimple

simple {Node2}
    gates:
        in: in;
endsimple

module {MyNet}
    submodules:
        node1: {Node1};
        node2: {Node2};
    connections:
        node1.out --> {MyConn} --> node2.in;
endmodule

network
     {myNet}: {MyNet};
endnetwork

%file: {}.cc

#include <omnetpp.h>

class {Node1} : public cSimpleModule
{
    virtual void initialize();
    virtual void handleMessage(cMessage *msg);
};

Define_Module({Node1});

void {Node1}::initialize()
{
    for (int i=0; i<5; i++)
    {
        cMessage *msg = new cMessage();
        msg->setLength(100); // so transmission time = 0.1s
        send(msg, "out");
    }
}

void {Node1}::handleMessage(cMessage *msg)
{
    ASSERT(false);
}

class {Node2} : public cSimpleModule
{
    virtual void handleMessage(cMessage *msg);
};

Define_Module({Node2});

void {Node2}::handleMessage(cMessage *msg)
{
    ev << "msg arrived at T=" << simTime();
    delete msg;
}

%inifile: {}.ini
[General]
network={myNet}

[Cmdenv]
express-mode=no
event-banners=no

%contains: stdout
msg arrived at T=1.1
msg arrived at T=1.2
msg arrived at T=1.3
msg arrived at T=1.4
msg arrived at T=1.5

