%description:
Stress test for activity().
- random delays ensure modules are activated (switched to) in random order
- use local vars to verify that the required stack size is indeed available
- verify that activity() modules can be created/deleted dynamically during simulation

%file: test.ned

simple Simple
{
}

network Test
{
    submodules:
        a[5]: Simple;
}

%file: test.cc

#include <omnetpp.h>

USING_NAMESPACE

namespace @TESTNAME@ {

class Simple : public cSimpleModule
{
  public:
    Simple() : cSimpleModule(32768) { }
    virtual void activity() override;
};

Define_Module(Simple);

void Simple::activity()
{
#ifdef USE_OMNETPP4x_FINGERPRINTS
    EV << "#UNRESOLVED: in USE_OMNETPP4x_FINGERPRINTS mode, different simtime rounding makes this test fail\n";
#endif

    char data[15000];  // slightly less than the requested stack, 16384
    char fill = (char)getId();
    for (int i = 0; i < (int)sizeof(data); i++)
        data[i] = fill;

    EV << "starting module\n";

    cModule *offspring = nullptr;
    ASSERT(getSimulation()->getActivityModule() == this);
    for (int i = 0; i < 10; i++)
    {
        wait(exponential(1.0));

        ASSERT(getSimulation()->getActivityModule() == this);
        ASSERT(fill == (char)getId());
        for (int j = 0; j < (int)sizeof(data); j++)
            ASSERT(data[j] == fill);

        if (i == 3)
        {
            EV << "creating new module\n";
            offspring = getModuleType()->createScheduleInit("x", getParentModule());
        }
        if (i == 8)
        {
            EV << "deleting new module\n";
            offspring->deleteModule();
        }
    }
}

}; //namespace

%exitcode: 0

%contains: stdout
Initializing module Test, stage 0
Initializing module Test.a[0], stage 0
Initializing module Test.a[1], stage 0
Initializing module Test.a[2], stage 0
Initializing module Test.a[3], stage 0
Initializing module Test.a[4], stage 0

Running simulation...
** Event #1  T=0   Test.a[0] (Simple, id=2)
starting module
** Event #2  T=0   Test.a[1] (Simple, id=3)
starting module
** Event #3  T=0   Test.a[2] (Simple, id=4)
starting module
** Event #4  T=0   Test.a[3] (Simple, id=5)
starting module
** Event #5  T=0   Test.a[4] (Simple, id=6)
starting module
** Event #6  T=0.795874504566   Test.a[0] (Simple, id=2)
** Event #7  T=0.898560388484   Test.a[1] (Simple, id=3)
** Event #8  T=0.923223131471   Test.a[4] (Simple, id=6)
** Event #9  T=1.255930758047   Test.a[2] (Simple, id=4)
** Event #10  T=1.685761528466   Test.a[1] (Simple, id=3)
** Event #11  T=1.806979244717   Test.a[2] (Simple, id=4)
** Event #12  T=1.859604212075   Test.a[3] (Simple, id=5)
** Event #13  T=2.344732375797   Test.a[3] (Simple, id=5)
** Event #14  T=2.662767954859   Test.a[1] (Simple, id=3)
** Event #15  T=2.74741984045   Test.a[0] (Simple, id=2)
** Event #16  T=2.802187185674   Test.a[4] (Simple, id=6)
** Event #17  T=2.845138545381   Test.a[2] (Simple, id=4)
** Event #18  T=2.860571854767   Test.a[4] (Simple, id=6)
** Event #19  T=2.92025157268   Test.a[3] (Simple, id=5)
** Event #20  T=3.015927093997   Test.a[1] (Simple, id=3)
creating new module
Initializing module Test.x, stage 0
** Event #21  T=3.015927093997   Test.x (Simple, id=7)
starting module
** Event #22  T=3.178927995609   Test.a[4] (Simple, id=6)
creating new module
Initializing module Test.x, stage 0
** Event #23  T=3.178927995609   Test.x (Simple, id=8)
starting module
** Event #24  T=3.403853677628   Test.a[3] (Simple, id=5)
creating new module
Initializing module Test.x, stage 0
** Event #25  T=3.403853677628   Test.x (Simple, id=9)
starting module
** Event #26  T=3.665373442248   Test.a[1] (Simple, id=3)
** Event #27  T=3.931602108922   Test.x (Simple, id=8)
** Event #28  T=4.057736244849   Test.a[3] (Simple, id=5)
** Event #29  T=4.164245451264   Test.a[1] (Simple, id=3)
** Event #30  T=4.237930806729   Test.a[1] (Simple, id=3)
** Event #31  T=4.243286530528   Test.x (Simple, id=9)
** Event #32  T=4.334447556652   Test.x (Simple, id=9)
** Event #33  T=4.58482321162   Test.x (Simple, id=7)
** Event #34  T=4.605248800019   Test.x (Simple, id=7)
** Event #35  T=4.649508802972   Test.a[1] (Simple, id=3)
** Event #36  T=4.851139195934   Test.a[4] (Simple, id=6)
** Event #37  T=4.970944262486   Test.a[0] (Simple, id=2)
** Event #38  T=5.064496937274   Test.x (Simple, id=7)
** Event #39  T=5.215727790939   Test.x (Simple, id=7)
creating new module
Initializing module Test.x, stage 0
** Event #40  T=5.215727790939   Test.x (Simple, id=10)
starting module
** Event #41  T=5.37906006496   Test.x (Simple, id=9)
** Event #42  T=5.866105509124   Test.a[3] (Simple, id=5)
** Event #43  T=6.160050825309   Test.a[2] (Simple, id=4)
creating new module
Initializing module Test.x, stage 0
** Event #44  T=6.160050825309   Test.x (Simple, id=11)
starting module
** Event #45  T=6.436996466411   Test.a[1] (Simple, id=3)
deleting new module
** Event #46  T=6.476728521123   Test.a[0] (Simple, id=2)
creating new module
Initializing module Test.x, stage 0
** Event #47  T=6.476728521123   Test.x (Simple, id=12)
starting module
** Event #48  T=6.507814681802   Test.a[3] (Simple, id=5)
** Event #49  T=6.529856194771   Test.x (Simple, id=8)
** Event #50  T=6.655730604209   Test.x (Simple, id=8)
** Event #51  T=7.055925926038   Test.a[1] (Simple, id=3)
** Event #52  T=7.211692942313   Test.a[0] (Simple, id=2)
** Event #53  T=7.256620006851   Test.x (Simple, id=10)
** Event #54  T=7.643753623512   Test.a[3] (Simple, id=5)
** Event #55  T=7.765290382371   Test.a[2] (Simple, id=4)
** Event #56  T=7.774052900202   Test.x (Simple, id=11)
** Event #57  T=7.798483304012   Test.a[3] (Simple, id=5)
deleting new module
** Event #58  T=7.930958306433   Test.x (Simple, id=8)
creating new module
Initializing module Test.x, stage 0
** Event #59  T=7.930958306433   Test.x (Simple, id=13)
starting module
** Event #60  T=7.993264495113   Test.x (Simple, id=12)
** Event #61  T=8.00130912461   Test.a[4] (Simple, id=6)
** Event #62  T=8.042904467066   Test.x (Simple, id=13)
** Event #63  T=8.128941201893   Test.x (Simple, id=10)
** Event #64  T=8.233124816662   Test.a[0] (Simple, id=2)
** Event #65  T=8.335144483923   Test.x (Simple, id=10)
** Event #66  T=8.350184819219   Test.x (Simple, id=13)
** Event #67  T=8.528830215341   Test.x (Simple, id=12)
** Event #68  T=8.536125040838   Test.a[2] (Simple, id=4)
** Event #69  T=8.643003826641   Test.a[4] (Simple, id=6)
** Event #70  T=8.668785598189   Test.x (Simple, id=8)
** Event #71  T=8.68775416739   Test.x (Simple, id=8)
** Event #72  T=8.772878706078   Test.x (Simple, id=12)
** Event #73  T=8.788281853933   Test.a[4] (Simple, id=6)
** Event #74  T=8.950418343379   Test.a[4] (Simple, id=6)
deleting new module
** Event #75  T=8.959267242402   Test.x (Simple, id=13)
** Event #76  T=9.210709174477   Test.x (Simple, id=13)
creating new module
Initializing module Test.x, stage 0
** Event #77  T=9.210709174477   Test.x (Simple, id=14)
starting module
** Event #78  T=9.219847984106   Test.a[3] (Simple, id=5)
** Event #79  T=9.37645974645   Test.a[2] (Simple, id=4)
** Event #80  T=9.670434668547   Test.x (Simple, id=10)
creating new module
Initializing module Test.x, stage 0
** Event #81  T=9.670434668547   Test.x (Simple, id=15)
starting module
** Event #82  T=9.699266223785   Test.x (Simple, id=14)
** Event #83  T=9.721379642414   Test.a[0] (Simple, id=2)
** Event #84  T=9.734259645144   Test.x (Simple, id=12)
creating new module
Initializing module Test.x, stage 0
** Event #85  T=9.734259645144   Test.x (Simple, id=16)
starting module
** Event #86  T=9.897415020554   Test.a[4] (Simple, id=6)
** Event #87  T=10.166898137465   Test.a[0] (Simple, id=2)
** Event #88  T=10.170257151845   Test.x (Simple, id=13)
** Event #89  T=10.297012300603   Test.x (Simple, id=14)
** Event #90  T=10.308792051885   Test.x (Simple, id=16)
** Event #91  T=10.370907342351   Test.x (Simple, id=16)
** Event #92  T=10.401573526378   Test.x (Simple, id=14)
** Event #93  T=10.668473378189   Test.x (Simple, id=11)
** Event #94  T=10.683754228641   Test.x (Simple, id=12)
** Event #95  T=10.815573623247   Test.x (Simple, id=15)
** Event #96  T=11.002999689265   Test.x (Simple, id=15)
** Event #97  T=11.239206395348   Test.x (Simple, id=15)
** Event #98  T=11.366364951302   Test.x (Simple, id=13)
** Event #99  T=11.500485993929   Test.x (Simple, id=14)
creating new module
Initializing module Test.x, stage 0
** Event #100  T=11.500485993929   Test.x (Simple, id=17)
starting module
** Event #101  T=11.50439363973   Test.x (Simple, id=13)
** Event #102  T=11.682610423969   Test.x (Simple, id=15)
creating new module
Initializing module Test.x, stage 0
** Event #103  T=11.682610423969   Test.x (Simple, id=18)
starting module
** Event #104  T=11.727307509677   Test.x (Simple, id=11)
** Event #105  T=11.794351674328   Test.x (Simple, id=12)
** Event #106  T=11.833534830741   Test.x (Simple, id=12)
** Event #107  T=11.879447958212   Test.x (Simple, id=17)
** Event #108  T=11.999348042761   Test.x (Simple, id=10)
** Event #109  T=12.075722981273   Test.x (Simple, id=18)
** Event #110  T=12.134712484194   Test.x (Simple, id=15)
** Event #111  T=12.24234759235   Test.x (Simple, id=15)
** Event #112  T=12.254374767728   Test.a[2] (Simple, id=4)
** Event #113  T=12.410859141548   Test.x (Simple, id=12)
** Event #114  T=12.440455199501   Test.x (Simple, id=13)
** Event #115  T=12.488676286504   Test.a[2] (Simple, id=4)
deleting new module
** Event #116  T=12.493249199159   Test.a[0] (Simple, id=2)
deleting new module
** Event #117  T=12.616368744927   Test.x (Simple, id=13)
deleting new module
** Event #118  T=12.885318963379   Test.x (Simple, id=17)
** Event #119  T=13.177399496646   Test.x (Simple, id=17)
** Event #120  T=13.300174005702   Test.x (Simple, id=15)
** Event #121  T=13.488284598553   Test.x (Simple, id=13)
** Event #122  T=13.551991914253   Test.a[0] (Simple, id=2)
** Event #123  T=13.712464173729   Test.x (Simple, id=17)
creating new module
Initializing module Test.x, stage 0
** Event #124  T=13.712464173729   Test.x (Simple, id=19)
starting module
** Event #125  T=13.871121026806   Test.x (Simple, id=16)
** Event #126  T=13.928115586693   Test.x (Simple, id=15)
** Event #127  T=13.992741182208   Test.x (Simple, id=19)
** Event #128  T=14.101243042839   Test.x (Simple, id=15)
deleting new module
** Event #129  T=14.218198452631   Test.x (Simple, id=15)
** Event #130  T=14.356245175332   Test.x (Simple, id=17)
** Event #131  T=14.40524241213   Test.x (Simple, id=19)
** Event #132  T=14.847985100877   Test.x (Simple, id=16)
creating new module
Initializing module Test.x, stage 0
** Event #133  T=14.847985100877   Test.x (Simple, id=20)
starting module
** Event #134  T=14.996697370129   Test.x (Simple, id=20)
** Event #135  T=15.229540944251   Test.x (Simple, id=16)
** Event #136  T=15.448421540758   Test.x (Simple, id=16)
** Event #137  T=15.47331460928   Test.x (Simple, id=19)
** Event #138  T=15.479413476865   Test.x (Simple, id=17)
** Event #139  T=15.93332856702   Test.x (Simple, id=19)
creating new module
Initializing module Test.x, stage 0
** Event #140  T=15.93332856702   Test.x (Simple, id=21)
starting module
** Event #141  T=15.946993145451   Test.x (Simple, id=21)
** Event #142  T=16.049138026976   Test.x (Simple, id=21)
** Event #143  T=16.453844888937   Test.x (Simple, id=10)
** Event #144  T=16.503332703402   Test.x (Simple, id=20)
** Event #145  T=16.565682857743   Test.x (Simple, id=17)
** Event #146  T=16.666717633052   Test.x (Simple, id=17)
** Event #147  T=17.024239961132   Test.x (Simple, id=21)
** Event #148  T=17.623147069156   Test.x (Simple, id=20)
** Event #149  T=17.653660224737   Test.x (Simple, id=19)
** Event #150  T=17.848776636747   Test.a[2] (Simple, id=4)
** Event #151  T=18.273663808221   Test.x (Simple, id=10)
** Event #152  T=18.285996821133   Test.x (Simple, id=19)
** Event #153  T=18.43561143261   Test.x (Simple, id=16)
** Event #154  T=18.492938359034   Test.x (Simple, id=16)
** Event #155  T=18.986247401554   Test.x (Simple, id=10)
** Event #156  T=19.421416855935   Test.x (Simple, id=16)
deleting new module
** Event #157  T=19.586194288195   Test.x (Simple, id=10)
deleting new module
** Event #158  T=19.606384416341   Test.x (Simple, id=10)
** Event #159  T=20.240306005396   Test.x (Simple, id=17)
deleting new module
** Event #160  T=20.280282304454   Test.x (Simple, id=17)
** Event #161  T=20.765662128087   Test.x (Simple, id=16)
** Event #162  T=20.773271420716   Test.x (Simple, id=21)
creating new module
Initializing module Test.x, stage 0
** Event #163  T=20.773271420716   Test.x (Simple, id=22)
starting module
** Event #164  T=21.10568166168   Test.x (Simple, id=22)
** Event #165  T=21.356149809583   Test.x (Simple, id=21)
** Event #166  T=21.484206574894   Test.x (Simple, id=21)
** Event #167  T=21.929626036814   Test.x (Simple, id=21)
** Event #168  T=22.280802126195   Test.x (Simple, id=21)
** Event #169  T=22.936448410559   Test.x (Simple, id=21)
deleting new module
** Event #170  T=23.062837046984   Test.x (Simple, id=21)

<!> No more events -- simulation ended at event #171, t=23.062837046984.
