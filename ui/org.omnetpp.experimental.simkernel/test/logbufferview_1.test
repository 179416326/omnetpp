%description:
Stress test for LogBufferView

%includes:

#include "commonutil.h"
#include "stringutil.h"
#include "logbuffer.h"
#include "logbufferview.h"

%global:

static int *createModule(int id)
{
    int *result = new int[3];
    result[0] = id; result[1] = 1000; result[2] = 0;
    return result;
}

static void getLine(LogBufferView *logView, int lineIndex)
{
    ev << "- getting line " << lineIndex << " out of " << logView->getNumLines() << ": ";
    ev << logView->getLine(lineIndex) << "\n";
}

static void exerciseLogView(LogBufferView *logView)
{
    ev << "Exercising logView:\n";

    int numLines = logView->getNumLines();

    // read random lines
    for (int i=0; i<2*numLines; i++)
        getLine(logView, intuniform(0, numLines-1));
}

%activity:

LogBuffer log(800);  // small buffer, so that we can test discards as well

std::vector<int> excludedModuleIds;
LogBufferView logView(&log, 2, excludedModuleIds); // filter for module id=2

log.addInfo("init line 1");
log.addInfo("init line 2");
log.addInfo("init line 3");

simtime_t simtime = 0;
for (int eventNumber=0; eventNumber<10000; eventNumber++)
{
    simtime += exponential(1.0);
    log.addEvent(eventNumber, simtime, createModule(intuniform(1,3)), opp_stringf("ev#%d t=%s", eventNumber, SIMTIME_STR(simtime)).c_str());
    int n = (int)floor(exponential(3));
    for (int line=0; line<n; line++)
        log.addLogLine(opp_stringf("log line #%d at event #%d",line,eventNumber).c_str());

    log.dump();
    exerciseLogView(&logView);
}

ev << "DONE.\n";

%contains: stdout
DONE.

