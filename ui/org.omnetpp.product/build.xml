<project name="org.omnetpp.product" default="build-omnetpp">
        <property environment="env" /> 
	<property file="build.properties" />
	
	<target name="clean">
		<delete dir="${buildDirectory}" />
	</target>

	<target name="init">
		<mkdir dir="${buildDirectory}" />
		<mkdir dir="${buildDirectory}/plugins" />
		<mkdir dir="${buildDirectory}/features" />
		<copy todir="${buildDirectory}/plugins">
			<fileset dir="../">
				<include name="org.omnetpp.*/**" />
				<include name="org.eclipse.cdt.*/**" />
				<include name="com.itsolut/**" />
				<exclude name="*/bin/**" />
				<exclude name="org.omnetpp.ide/**" />
				<exclude name="org.omnetpp.scave.old/**" />
				<exclude name="org.omnetpp.test.*/**" />
				<exclude name="org.omnetpp.experimental.*/**" />
			</fileset>
		</copy>
		<copy todir="${buildDirectory}/features">
			<fileset dir="../">
				<include name="org.omnetpp.ide/**" />
				<include name="org.omnetpp.ide.commercial/**" />
				<include name="org.omnetpp.ide.academic/**" />
				<include name="com.itsolut/**" />
			</fileset>
		</copy>
	</target>
	
	<!--
		This target actually executes the PDE Build process by launching the 
		Eclipse antRunner application.
	-->
	<target name="pde-build">
		<java classname="org.eclipse.equinox.launcher.Main" fork="true" failonerror="true">
			<arg value="-application" />
			<arg value="org.eclipse.ant.core.antRunner" />
			<arg value="-Declipse.pdebuild.scripts=${eclipse.pdebuild.scripts}" />
			<arg value="-buildfile" />
			<arg value="${eclipse.pdebuild.scripts}/productBuild/productBuild.xml" />
			<arg value="-Dtimestamp=${timestamp}" />
			<arg value="-DforceContextQualifier=${env.BUILDID}" />
			<classpath>
				<pathelement location="${eclipseLocation}/plugins/org.eclipse.equinox.launcher_${equinoxLauncherPluginVersion}.jar" />
			</classpath>
		</java>
		<!-- remove eclipse P2 provisioning related packages. currently we are using
		     the old update manager -->
		<delete>
			<fileset dir="${eclipseLocation}">
				<include name="plugins/org.eclipse.ecf.*/**" />
				<include name="features/org.eclipse.ecf.*/**" />
				<include name="plugins/org.eclipse.equinox.p2.*/**" />
				<include name="features/org.eclipse.equinox.p2.*/**" />
			</fileset>
		</delete>
	</target>

	<!-- prepare for a commercial build / replace OMNeT++ strings to OMNEST etc. -->	
	<target name="init-omnest" depends="init">
	    <replace dir="${buildDirectory}" token="OMNeT++" value="OMNEST">
		<include name="**/*.java"/>
		<include name="**/*.htm" />
		<include name="**/*.html"/>
		<include name="**/*.xml"/>
		<include name="**/MANIFEST.MF"/>
		<include name="**/*.properties"/>
		<include name="**/*.product"/>
	    </replace>	
	    <copy file="${buildDirectory}/plugins/org.omnetpp.product/omnest-ide.product" tofile="${buildDirectory}/plugins/org.omnetpp.product/ide.product"/>
	    <move file="${buildDirectory}/plugins/org.omnetpp.main/splash-omnest.bmp" tofile="${buildDirectory}/plugins/org.omnetpp.main/splash.bmp"/>
    	</target>
	
	<!-- prepare for academic build / throw out commercial features etc. -->	
	<target name="init-omnetpp" depends="init">
	    <copy file="${buildDirectory}/plugins/org.omnetpp.product/omnetpp-ide.product" tofile="${buildDirectory}/plugins/org.omnetpp.product/ide.product"/>
    	</target>
	
	<target name="build-omnetpp" depends="clean, init-omnetpp, pde-build" >
	    <!-- special handling of the 64 bit linux executable -->
	    <copy file="${eclipseLocation}/eclipse64" tofile="${buildDirectory}/tmp/${archivePrefix}/omnetpp64"/>
	    <chmod file="${buildDirectory}/tmp/${archivePrefix}/omnetpp64" perm="755"/>
	    <delete file="${buildDirectory}/tmp/${archivePrefix}/libcairo-swt.so" />
	</target>
	
	<target name="build-omnest" depends="clean, init-omnest, pde-build" >
	    <!-- special handling of the 64 bit linux executable -->
	    <copy file="${eclipseLocation}/eclipse64" tofile="${buildDirectory}/tmp/${archivePrefix}/omnest64"/>
	    <chmod file="${buildDirectory}/tmp/${archivePrefix}/omnest64" perm="755"/>
	    <delete file="${buildDirectory}/tmp/${archivePrefix}/libcairo-swt.so" />
	</target>
</project>