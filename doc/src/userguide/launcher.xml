<?xml version="1.0"?>
<!DOCTYPE chapter SYSTEM "custom-docbook.dtd">
<chapter id="launcher">
  <title>Launching and Debugging</title>
  <sect1>
    <title>Introduction</title>
    <para>
      The &Omnetpp; IDE lets you execute single simulations and simulation batches, and also
      to debug and, to some extent, profile simulations. You can choose whether you want
      the simulation to run in graphical mode (using ``Tkenv'') or in console (using ``Cmdenv'');
      which simulation configuration and run number to execute; whether to record an eventlog or not;
      and many other options.
    </para>

    <para>
      When running simulation batches, you can specify the number of processes allowed
      to run in parallel, so you can take advantage of multiple processors or processor cores.
      The progress of the batch can be monitored, and you can also kill processes from the
      batch if needed. Batches are based on the ``parameter study'' feature of INI files;
      you can read more about it in the ``&Omnetpp; User Manual''.
    </para>

    <para>
      Debugging support comes from the Eclipse C/C++ Development Toolkit (CDT), and beyond
      the basics (single-stepping, stack trace, breakpoints, watches, etc.) it also offers you
      several conveniences and advanced functionality such as inspection tooltips,
      conditional breakpoints and so on. Debugging with CDT also has extensive literature
      on the Internet. Currently CDT uses the GNU Debugger (gdb) as the underlying debugger.
    </para>

    <para>
      Profiling support is based on the ``valgrind'' program, http://valgrind.org. Valgrind is
      a suite of tools for debugging and profiling on Linux. It can automatically detect various
      memory access and memory management bugs, and perform detailed profiling of your program.
      Valgrind support is brought into the &Omnetpp; IDE by the Linux Tools Project of Eclipse,
      currently in incubation state.
    </para>
  </sect1>

  <sect1>
    <title>Launch Configurations</title>
    <para>
      Eclipse, and thus the IDE as well, uses ``launch configurations'' to store particulars
      of the program to be launched: what program to run, the list of arguments and
      environment variables, and other options. Eclipse and its C/C++ Development Toolkit (CDT)
      already comes with several types of launch configurations (e.g. "C/C++ Application"),
      and the IDE adds ``&Omnetpp; Simulation''. The same launch configuration can be used with
      the ``Run'', ``Debug'' and ``Profile'' buttons alike.
    </para>
  </sect1>

  <sect1>
    <title>Running a Simulation</title>

    <sect2>
      <title>Quick Run</title>
      <para>
        The easiest way to launch a simulation is by selecting a project, folder, ini or NED file
        in ``Project Explorer'', and clicking the ``Run'' button on the toolbar. This will
        create a suitable launch configuration (possibly after asking a few questions to
        clarify what you want to run) if one does not exist already. Instead of the ``Run''
        button, you can also choose the ``Run As... | &Omnetpp; Simulation'' from the item's
        context menu.
      </para>
      <para>The details:</para>
      <itemizedlist>
        <listitem>If a folder is selected and it contains a single INI file, the IDE will use
        this file to start the simulation.</listitem>
        <listitem>If an INI file is selected, it will be used during the launch as the main INI file
        for the simulation.</listitem>
        <listitem>If a NED file is selected which contains a network definition, the IDE will
        scan for INI files in the active projects and will try to find a configuration that allows
        this network to start.</listitem>
      </itemizedlist>
    </sect2>

    <sect2>
      <title>The Run Configurations Dialog</title>
      <para>
        Launch configurations can be managed in the ``Run Configurations'' dialog. (Two further
        dialogs, ``Debug Configurations'' and ``Profile Configurations'' are very similar, and
        allow you to manage debugging/profiling aspects of launch configurations).
      </para>
      <para>
        The ``Run Configurations'' can be opened in various ways: via the main menu (``Run | Run Configurations...'');
        via the context menu item of a project, folder or file (``Run As | Run Configurations...'');
        via the green ``Run'' toolbar button (``Run Configurations...'' item of its attached menu, or
        by <keycap>Ctrl</keycap>-clicking any other menu item or the toolbar button itself).
      </para>
      <picture file="pictures/Launch-RunProject.png">One way of opening the ``Run Configurations'' dialog</picture>
    </sect2>

    <sect2>
      <title>Creating a Launch Configuration</title>
      <para>&Omnetpp; IDE adds a new Eclipse launch configuration type, ``&Omnetpp; Simulation'',
        that supports launching simulation executables. To create a new run configuration,
        open the ``Run Configurations...'' dialog. In the dialog, select ``&Omnetpp; Simulation''
        from the tree, and click the ``New launch configuration'' icon in the top-left corner.
        A blank launch configuration is created; you can give it a name at the top of the form
        that appears.
      </para>
      <picture file="pictures/Launch-RunDialog.png">The Simulation Launcher</picture>
      <para> The ``Main'' tab of the configuration dialog was designed to make the launching of simulations as
        easy as possible. The only required field is the Working directory; all others have defaults. If you
        only select the working directory and the simulation program, it will start "Run 0" of the first
        configuration from the [[omnetpp.ini]] file in the specified working directory.
      </para>
      <tip>
        Hover your mouse above the controls in this dialog and you will receive tooltip help for the
        selected control.
      </tip>
      <note>
        The ``Launch'' dialog will try to figure out your initial settings automatically. If you select an INI
        file in the ``Project Explorer View'', or the active editor contains an INI file before launching the
        ``Run'' dialog, the INI file and working directory field will be automatically populated for you. The
        dialog will try to guess the executable name based on the settings of your current open projects.
      </note>
      <itemizedlist>
        <listitem>
          <para> ``Working directory'': Set it to your working directory. Several of the below entries are
            treated as relative to this directory. Changing the working directory may invalidate previously
            selected entries in other fields of the dialog.</para>
        </listitem>
        <listitem>
          <para> ``Simulation program'': You must set the name of the simulation executable here. This path is
            relative to the workspace root. You may use the ``Browse...'' button to select the executable
            directly. If your project output is a shared library, select "opp_run". The launcher dialog will
            use the "opp_run" helper executable to launch your simulation in the shared library. Check whether
            the "Dynamic Libraries" field in the advanced section contains the libraries you want to load.
          </para>
          <warning>
            If you want to debug your simulation, be sure to select the 'debug' version of your executable
            here.
          </warning>
        </listitem>
        <listitem>
          <para> ``Initialization file(s)'': You should specify one or more INI files that will be used to launch the
            simulation. Specifying more than one file simply loads all those files in the specified order.
          </para>
        </listitem>
        <listitem>
          <para>
            ``Configuration name'': Once you specify a legal INI file, the box will present all of the
            Config sections in that file. In addition, it will display the description of that section and the
            information regarding which Config section is extended by this section. You may select which Configuration
            should be launched.
            <note>
              The working directory and the INI file must contain valid entries before trying to set this
              option.
            </note>
          </para>
        </listitem>
        <listitem>
          <para> ``Run number'': It is possible to specify which run number(s) must be executed for the
            simulation. If the executable name and the INI file were already selected, it is possible to hover
            above the field to get more information about the possible run numbers. You can use comma and .. to
            separate the run numbers; for example, 1,2,5..9,20 corresponds to run numbers 1,2,5,6,7,8,9,20.
            Entering a single asterisk (*) corresponds to all run numbers. Running several simulations in this
            manner is called batch execution. If you do not specify anything, Run 0 will be executed.
          </para>
          <note>
            Batch execution is possible only if you run your program in the command line environment. The simulation
            was built to support command line environment (Cmdenv) and the User interface selection is
            'Command line' (see User interface selection).
          </note>
        </listitem>
        <listitem>
          <para>``Processes to run in parallel'': With batch execution, it is possible to tell the
            launcher to keep two or more simulations running at a time. This way you can take advantage of
            multiple CPUs or CPU cores.</para>
          <note>
            This is usually an easier and more efficient way to exploit multiprocessing power than parallel
            simulation (PDES).
          </note>
          <warning>
            Use this option only if your simulation is CPU-limited and you have enough physical
            RAM to support all of the processes at the same time. Do not set it higher than the number of
            physical processors or cores you have in your machine.
          </warning>
        </listitem>
        <listitem>
          <para> ``User interface'': You can specify which UI environment should be used during execution;
            currently command line (Cmdenv) and Tcl/Tk (Tkenv) is supported. The executable must be linked
            with the correct UI library or the UI should be loaded dynamically.</para>
          <note>
            Batch execution and progress feedback during execution is supported only for the command line
            environment.
          </note>
        </listitem>
        <listitem>
          <para>``Record Eventlog'': Choosing "Default" uses the settings specified in the INI file,
            however you may explicitly enable or disable simulation event logging. This is useful if you want
            to temporarily switch the logging on or off.</para>
        </listitem>
        <listitem>
          <para>
            ``Dynamic libraries'': A simulation may load additional DLLs or shared libraries before execution
            or your entire simulation may be built as a shared library. The ``Browse'' button is available to
            select one or more files (use <keycap>Ctrl</keycap> +
            click for multiple selection). This option can be used to load simulation code (i.e. simple
            modules), user interface libraries, or other extension libraries (scheduler, output file managers,
            etc.). The special macro [[${opp_shared_libs:/workingdir}]] expands to all shared libraries
            provided by the current project or any other project on which you currently depend.
          </para>
          <note>If
            your simulation is built as a shared library, you must use the "opp_run" stub executable to start
            it. opp_run is basically an empty &Omnetpp;
            executable which understands all command line options, but does not contain any simulation code.
          </note>
          <warning>If
            you use external shared libraries (i.e. libraries other than the ones provided by the current open
            projects or &Omnetpp;
            itself), you must ensure that the executable part has access to the shared library. On Windows, you
            must set the [[PATH]], while on Linux and Mac you must set the [[LD_LIBRARY_PATH]] to point to the
            directory where the DLLs or shared libraries are located. You can set these variables either
            globally or in the ``Environment'' tab in the ``Launcher Configuration Dialog''.
          </warning>
        </listitem>
        <listitem>
          <para>
            ``NED Source Path'': The directories where the NED files are read from (relative to the first
            selected INI file.)
            <tip>
              The variable [[${opp_ned_path:/workingdir}]] refers to an automatically calculated path (derived
              from project settings). If you want to add additional NED folders to the automatically
              calculated list, use the [[${opp_ned_path:/workingdir}:/my/additional/path]] syntax.
            </tip>
          </para>
        </listitem>
        <listitem>
          <para> ``Additional arguments'': Other command line argument can be specified here and will be
            passed to the simulation process.</para>
        </listitem>
        <listitem>
          <para> ``Show Debug View on Launch'': This is a convenience function that allows the user to open the Debug View on simulation
            execution. ``Debug View'' allows you to see and terminate the processes you have launched and
            gives you the option to switch between their outputs in the console view.</para>
        </listitem>
      </itemizedlist>
      <sect3>
        <title>Related Command-Line Arguments</title>
        <!-- TODO add some troubleshooting -->
        <para> Most settings in the dialog simply translate to command-line options to the simulation
          executable. This is summarized in the following list:</para>
        <itemizedlist>
          <listitem>
            <para> Initialization files: maps to multiple [[-f &lt;inifile&gt;]] options
            </para>
          </listitem>
          <listitem>
            <para>Configuration name: adds a [[-c &lt;configname&gt;]] option</para>
          </listitem>
          <listitem>
            <para>Run number: adds a [[-r &lt;runnumber&gt;]] option</para>
          </listitem>
          <listitem>
            <para>User interface: adds a [[-u &lt;userinterface&gt;]] option</para>
          </listitem>
          <listitem>
            <para>Dynamically loaded libraries: maps to multiple [[-l &lt;library&gt;]] options
            </para>
          </listitem>
          <listitem>
            <para>NED Source Path : adds a [[-n &lt;ned_source_path&gt;]] option</para>
          </listitem>
        </itemizedlist>
      </sect3>
    </sect2>
  </sect1>

  <sect1>
    <title>Batch Execution</title>
    <para>
      In previous versions of &Omnetpp;, to run a simulation several times with different
      parameters, you had to create an external script that created an INI file for each
      run and started the simulation with the specified file. In &Omnetpp; 4.x, it is no
      longer needed. The improved INI file syntax allows you to specify loops for
      specific parameters so you no longer need separate INI files for each run. In
      addition, the IDE itself supports starting your simulation several times.
    </para>
    <picture file="pictures/Launch-BatchRun.png">
      Iteration variable in the INI file
    </picture>
    <note>Batch running is supported only in the command line environment.</note>
    <para>
      If you create a [[Configuration]] with one or more iteration variables, you will be able
      to run your simulations to explore the parameter space defined by those variables. Practically,
      the IDE creates the Cartesian product from these variables and assigns a run number
      to each product. It is possible to execute one, several or all runs of the simulation
      by specifying the ``Run number''
      field in the ``Run Dialog''. You can specify a single number (e.g. 3), a combination
      of several numbers (e.g. 2,3,6,7..11) or all run numbers (using *).
    </para>
    <tip>
      If you already have specified your executable, chosen the configuration which should be
      run and selected the command line environment, you may try to hover over the
      ``Run Number'' field. This will give you a description of the possible runs and how they are
      associated with the iteration variable values (the tooltip is calculated by
      executing the simulation program with the [[-x Configuration -G]] options in command line mode).
    </tip>
    <picture file="pictures/Launch-BatchRun2.png">
      Iteration loop expansion in a tooltip
    </picture>
    <para>
      If you have a multi-core or multi-processor system and have ample memory, you may
      try to set the ``Processes to run parallel''
      field to a higher number. This will allow the IDE to start more simulation processes
      in parallel, resulting in a much lower overall simulation time for the whole batch.
    </para>
    <warning>
      Be aware that you need enough memory to run all these processes in parallel. We
      recommend using this feature only if your simulation is CPU-bound. If you do not
      have enough memory, your operating system may start to use virtual memory,
      dramatically decreasing the overall performance.
    </warning>
  </sect1>

  <sect1>
    <title>Debugging a Simulation</title>
    <para>
      The &Omnetpp; IDE integrates with the CDT (C/C++ Development Tooling) of Eclipse. If you want to
      debug your application, you have to do it by starting it from the
      ``Run|Debug Configurations''
      . You should launch your debugging session exactly the same way you were running it.
    </para>
    <note>
      If you have problems with starting the debug session, check whether:
      <itemizedlist>
        <listitem>your executable is built with debug information,</listitem>
        <listitem>
          you can run the same executable without problem (using the same launch
          configuration), and
        </listitem>
        <listitem>
          the Debugger type is set properly on the ``Debugger'' tab of the ``Launch'' dialog.
        </listitem>
      </itemizedlist>
    </note>
    <warning>
      Batch (and parallel) execution is not possible in this launch type, so you may
      specify only a single run number.
    </warning>
    <sect2>
      <title>Using pretty printers during debugging</title>
      <para>In C++, certain data structures may be very cryptic and hard to understand. On Windows
        and Linux machines, CDT allows you to use "pretty printers" that display the values
        of these structures in a human readable form. Pretty printers are actually small
        scripts written in python programming language and they are initialized when the
        debugger starts.
      </para>
      <para>By default, the &Omnetpp; IDE comes with pretty printers for containers in the
          standard C++ library and also for certain &Omnetpp; specific data types like
          ``cModule'', ``simtime_t'' etc. The default gdb initialization script
          (``${opp_root}/misc/gdb/gdbinit.py'') is used automatically for each new
          launch configuration on the ``Debugger'' tab for the ``GDB command file'' field.
          The IDE will offer you using this initialization file automatically if the launch
          configuration was created with &Omnetpp; 4.2 or earlier. The default script will
          initialize the pretty printers also look into the debugger project (and all
          projects it depends on) and will try to invoke the ``.gdbinit.py'' file from the
          root folder of the project, if it exists. This mechanism allows you to write project
          specific pretty printers for complex data structures.
      </para>
    </sect2>
  </sect1>
  <sect1>
    <title>Profiling a Simulation on Linux</title>
    <para>
      On Linux systems, the &Omnetpp; IDE supports executing your simulation using the ``valgrind'' program.
      Running your program with valgrind allows you to find memory-related issues and programming errors
      in your code. The simulation will run in an emulated environment (much slower than normal
      execution speeds), but valgrind will generate a detailed report when it finishes.
      The report is shown in a separate ``Valgrind View'' at the end of the simulation run.
      The &Omnetpp; IDE contains support only for the ``memcheck'' tool. If you want to use
      other tools (``cachegrind, callgrind, massif'' etc.), you may try to install the full 'Linux
      Tools Project' from the Eclipse Marketplace.
    </para>

    <para>
      To start profiling, right-click on your project in the ``Project Explorer'' tree
      and select ``Profile As... | &Omnetpp; Simulation''. Valgrind must already be installed
      on your system.
    </para>
    <note>
        Simulation executes considerably slower than a normal run. Prepare for long run-times or
        limit the simulation time in your .INI file. You do not need statistical convergence here,
        just run long enough that all the code paths are executed in your model.
    </note>
  </sect1>

  <sect1>
    <title>Controlling the Execution and Progress Reporting</title>
    <para>
      After starting a simulation process or simulation batch you can keep track of the
      started processes in the ``Debug View''. To open the ``Debug View'' automatically during
      launch, check the Show Debug View on Launch in the run configuration dialog, or
      select ``Window | Show View... | Other... | Debug | Debug''.
      Select a process and click the terminate button to stop a specific simulation run
      or use the context menu for more options to control the process execution.
    </para>
    <picture file="pictures/Launch-DebugView.png">Debug View</picture>
    <tip>
      Place the Debug View in a different tab group than the console so you will be able
      to switch between the process outputs and see the process list at the same time.
    </tip>
    <note>
      You can terminate all currently running processes by selecting the root of the
      launch. This will not cancel the whole batch; only the currently active processes. If
      you want to cancel the whole batch, open the ``Progress View'' and cancel the simulation
      batch there.
    </note>
    <para>
      Clicking on the process in the ``Debug View'' switches to the output of that process in
      the ``Console View''. The process may ask for user input via the console, too. Switch to the
      appropriate console and enter the requested parameters.
    </para>
    <picture file="pictures/Launch-ConsoleView.png">
      Displaying the output of a simulation process in Console View
    </picture>
    <note>
      By default, the ``Console View'' automatically activates when a process is writing to it.
      If you are running several parallel processes, this might be an annoying behavior
      and might prevent you from switching to the ``Progress View''. You can switch off the auto-activation by disabling the
      ``Show Console When Standard Out/Error Changes''
      in the ``Console View'' toolbar.
    </note>

    <sect3>
    <title>Progress Reporting</title>
      <para>
        If you have executed the simulation in the command line environment, you can
        monitor the progress of the simulation in the ``Progress View''. See the status line
        for the overall progress indicator and click on it to open the detailed progress
        view. It is possible to terminate the whole batch by clicking on the cancel button
        in the ``Progress View''.
      </para>
      <picture file="pictures/Launch-ProgressView.png">
        Progress report on four parallel processes
      </picture>
      <note>
        When ``Progress View'' displays "Waiting for user input", the simulation is waiting for
        the user. Switch to the appropriate console and provide the requested input for
        the simulation.
      </note>
      <note>
        By default, cmdenv reports progress only on every 100,000th event. If you want more frequent
        progress reports, set the
        [[cmdenv-status-frequency]]
        option in your INI file to a lower value.
      </note>
    </sect3>
  </sect1>
</chapter>
