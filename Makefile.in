#=====================================================================
#
# toplevel makefile for OMNeT++ libraries and programs
#
#=====================================================================

#
# Directories
#
OMNETPP_SRC_DIR =       @OMNETPP_SRC_DIR@
OMNETPP_SAMPLES_DIR =   @OMNETPP_SAMPLES_DIR@

#=====================================================================
#
# Main targets
#
#=====================================================================


all: check-env components

components: libs progs install-local samples


#=====================================================================
#
# OMNeT++ components
#
#=====================================================================

LIBS=sim envir cmdenv tkenv
PROGS=utils nedc gned plove
SAMPLES=dyna fddi fifo1 fifo2 hcube hist nim pvmex token demo

#
# Group targets. Note that utils has to be built BEFORE other libs and progs
# because tcl2c might be needed to build tkenv or gned.
#
libs: utils $(LIBS)
progs: $(PROGS)
samples: $(SAMPLES)


#
# Libraries
#

sim:
	cd $(OMNETPP_SRC_DIR)/sim && $(MAKE)

envir:
	cd $(OMNETPP_SRC_DIR)/envir && $(MAKE)

cmdenv:
	cd $(OMNETPP_SRC_DIR)/cmdenv && $(MAKE)

tkenv:
	cd $(OMNETPP_SRC_DIR)/tkenv && $(MAKE)

#
# Programs
#

nedc:
	cd $(OMNETPP_SRC_DIR)/nedc && $(MAKE)

gned:
	cd $(OMNETPP_SRC_DIR)/gned && $(MAKE)

plove:
	@ # needs no build

utils:
	cd $(OMNETPP_SRC_DIR)/utils &&  $(MAKE)

#
# Sample programs
#

dyna:
	cd $(OMNETPP_SAMPLES_DIR)/dyna && $(MAKE)

fddi:
	cd $(OMNETPP_SAMPLES_DIR)/fddi && $(MAKE)

fifo1:
	cd $(OMNETPP_SAMPLES_DIR)/fifo1 && $(MAKE)

fifo2:
	cd $(OMNETPP_SAMPLES_DIR)/fifo2 && $(MAKE)

hcube:
	cd $(OMNETPP_SAMPLES_DIR)/hcube && $(MAKE)

hist:
	cd $(OMNETPP_SAMPLES_DIR)/hist && $(MAKE)

nim:
	cd $(OMNETPP_SAMPLES_DIR)/nim && $(MAKE)

pvmex:
	cd $(OMNETPP_SAMPLES_DIR)/pvmex && $(MAKE)

token:
	cd $(OMNETPP_SAMPLES_DIR)/token && $(MAKE)

demo:
	cd $(OMNETPP_SAMPLES_DIR)/demo && $(MAKE)

#=====================================================================
#
# Utilities
#
#=====================================================================

check-env:
	@probefile=__tmp__
        echo '' >@OMNETPP_BIN_DIR@/$probefile \
	chmod +x  @OMNETPP_BIN_DIR@/$probefile \
	if $probefile >/dev/null 2>/dev/null; then :; else \
	  echo ' *** Warning: @OMNETPP_BIN_DIR@ is not in the path, some components won'\''t build!'; \
	fi \
	rm -f @OMNETPP_BIN_DIR@/$probefile \
        if uname | grep "CYGWIN" >/dev/null; then :; else \
	  if echo $$LD_LIBRARY_PATH | grep "@OMNETPP_LIB_DIR@" >/dev/null; then :; else \
	    echo ' *** Warning: Looks like @OMNETPP_LIB_DIR@ is not in LD_LIBRARY_PATH, shared libs may not work!'; \
          fi \
	fi

clean:
	for i in $(LIBS) $(PROGS); do \
	    (cd $(OMNETPP_SRC_DIR)/$$i && $(MAKE) clean); \
	done
	for i in $(SAMPLES); do \
	    (cd $(OMNETPP_SAMPLES_DIR)/$$i && $(MAKE) clean); \
	done

depend:
	for i in $(LIBS) $(PROGS); do \
	    (cd $(OMNETPP_SRC_DIR)/$$i && $(MAKE) depend); \
	done
	for i in $(SAMPLES); do \
	    (cd $(OMNETPP_SAMPLES_DIR)/$$i && $(MAKE) depend); \
	done

install-local:
	for i in $(LIBS) $(PROGS); do \
	    (cd $(OMNETPP_SRC_DIR)/$$i && $(MAKE) install-local); \
	done

