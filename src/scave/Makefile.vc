#
# Global definitions
#
!include ..\..\configuser.vc

# Make sure that output locations are set
!if "$(OMNETPP_BIN_DIR)"==""
!error OMNETPP_BIN_DIR must be correctly set
!endif
!if "$(OMNETPP_OUT_DIR)"==""
!error OMNETPP_OUT_DIR must be correctly set
!endif
!if "$(OMNETPP_LIB_DIR)"==""
!error OMNETPP_LIB_DIR must be correctly set
!endif

#
# Local definitions
#
LIBNAME=oppscave$D
O=$(OMNETPP_OUT_DIR)/$(OUTPUT_PREFIX)$(TOOLCHAIN_NAME)-$(MODE)/src/scave
L=$(OMNETPP_LIB_DIR)/$(OUTPUT_PREFIX)$(TOOLCHAIN_NAME)

COPTS= $(CFLAGS) $(XML_CFLAGS) -I. -I../common -I"$(OMNETPP_INCL_DIR)/platdep" /Fd"$O/$(LIBNAME).pdb"
IMPLIBS= $O/../common/oppcommon$D.lib $(XML_LIBS)

!if "$(BUILDING_UILIBS)"=="yes"
COPTS= $(COPTS) -DTHREADED $(PTHREAD_CFLAGS)
IMPLIBS= $(IMPLIBS) $(PTHREAD_LIBS)
!endif

OBJS= $O/arraybuilder.obj $O/channel.obj $O/commonnodes.obj $O/compoundfilter.obj \
      $O/dataflowmanager.obj $O/datasorter.obj $O/diffquot.obj \
      $O/filewriter.obj $O/filternodes.obj $O/customfilter.obj $O/stddev.obj \
      $O/idlist.obj $O/mergernodes.obj $O/nodetype.obj $O/nodetyperegistry.obj \
      $O/resultfilemanager.obj $O/slidingwinavg.obj \
      $O/vectorfilereader.obj $O/vectorfilewriter.obj $O/windowavg.obj \
      $O/xyplotnode.obj $O/indexedvectorfile.obj \
      $O/vectorfileindexer.obj $O/indexfile.obj $O/scaveutils.obj \
      $O/scaveexception.obj $O/enumtype.obj $O/export.obj $O/teenode.obj \
      $O/indexedvectorfilereader.obj $O/xyarray.obj $O/fields.obj \
      $O/indexedvectorfilereader2.obj

!if "$(LIB_SUFFIX)"==".dll"
COPTS= $(COPTS) -DSCAVE_EXPORT
!endif

#
# Automatic rules
#
.SUFFIXES : .cc

{.}.cc{$O}.obj:
	$(Q)$(CXX) /Fo"$@" $(CXXFLAGS) $(COPTS) /c /Tp $<


#
# Targets (TBD: build dll)
#
all : $O/$(LIBNAME)$(LIB_SUFFIX) $O/scavetool.exe

$O/$(LIBNAME).lib : $(OBJS) $L
	@echo Creating LIB: $@
	$(Q)$(AR) /out:"$@" $(OBJS)
	$(Q)copy $(O:/=\)\$(LIBNAME).lib $(L:/=\) 1>nul
	-$(Q)copy /b $(O:/=\)\$(LIBNAME).pdb $(L:/=\) 1>nul

$O/$(LIBNAME).dll : $(OBJS) $L
	@echo Creating DLL: $@
	$(Q)$(SHLIB_LD) /out:"$@" /subsystem:console $(OBJS) $(IMPLIBS) $(LDFLAGS)
	$(Q)copy $(O:/=\)\$(LIBNAME).dll $(OMNETPP_BIN_DIR:/=\) 1>nul
	-$(Q)copy /b $(O:/=\)\$(LIBNAME).dll.manifest $(OMNETPP_BIN_DIR:/=\) 1>nul
	$(Q)copy $(O:/=\)\$(LIBNAME).lib $(L:/=\) 1>nul
	-$(Q)copy /b $(O:/=\)\$(LIBNAME).pdb $(L:/=\) 1>nul

$O/scavetool.exe : $O/scavetool.obj $O/$(LIBNAME)$(LIB_SUFFIX)
	@echo Creating EXE: $@
	$(Q)$(LINK) $(LDFLAGS) /nologo /out:"$@" $O/scavetool.obj $(O:/=\)\$(LIBNAME).lib $(IMPLIBS)
	$(Q)copy $(O:/=\)\scavetool.exe $(OMNETPP_BIN_DIR:/=\) 1>nul
	-$(Q)copy $(O:/=\)\scavetool.exe.manifest $(OMNETPP_BIN_DIR:/=\) 1>nul

$O/scavetool.obj : scavetool.cc $O
	@: Note: not in OBJS because scavetool.cc must be compiled *without* -DSCAVE_EXPORT
	$(Q)$(CXX) $(CFLAGS) $(PTHREAD_CFLAGS) -I. -I../common -I"$(OMNETPP_INCL_DIR)/platdep" /c /Fo"$@" /Tp scavetool.cc

$(OBJS): $O

$O $L:
	@md $(@:/=\)

doc:
	@echo Generating documentation...
	$(Q)$(DOXYGEN:/=\) doxy.cfg

depend:
	$(qecho) Creating dependencies...
	$(Q)$(MAKEDEPEND) -I. -I../common -fMakefile.vc -P^$O/ -- *.cc

clean:
	$(qecho) Cleaning...
	-$(Q)rmdir /s /q $(O:/=\) 2>nul
	-$(Q)del /q $(L:/=\)\$(LIBNAME).* $(OMNETPP_LIB_DIR:/=\)\$(LIBNAME).* 2>nul
	-$(Q)cd $(OMNETPP_BIN_DIR:/=\) && del /q scavetool.exe* 2>nul

# DO NOT DELETE THIS LINE -- make depend depends on it.
$O/arraybuilder.obj: arraybuilder.cc \
  ../common/exception.h \
  arraybuilder.h \
  scavedefs.h \
  ../common/filereader.h \
  node.h \
  ../common/commondefs.h \
  ../common/progressmonitor.h \
  nodetype.h \
  dataflowmanager.h \
  xyarray.h \
  channel.h \
  ../common/bigdecimal.h \
  commonnodes.h \
  ../common/commonutil.h
$O/channel.obj: channel.cc \
  ../common/commondefs.h \
  ../common/commonutil.h \
  ../common/bigdecimal.h \
  channel.h \
  ../common/exception.h \
  scavedefs.h \
  node.h
$O/commonnodes.obj: commonnodes.cc \
  ../common/exception.h \
  ../common/filereader.h \
  scavedefs.h \
  node.h \
  ../common/commondefs.h \
  ../common/progressmonitor.h \
  nodetype.h \
  dataflowmanager.h \
  channel.h \
  ../common/bigdecimal.h \
  commonnodes.h \
  ../common/commonutil.h
$O/compoundfilter.obj: compoundfilter.cc \
  nodetyperegistry.h \
  ../common/exception.h \
  ../common/filereader.h \
  scavedefs.h \
  node.h \
  filternodes.h \
  compoundfilter.h \
  ../common/commondefs.h \
  nodetype.h \
  ../common/progressmonitor.h \
  dataflowmanager.h \
  channel.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  commonnodes.h
$O/customfilter.obj: customfilter.cc \
  scaveutils.h \
  ../common/stringutil.h \
  scavedefs.h \
  ../common/stringpool.h \
  commonnodes.h \
  channel.h \
  dataflowmanager.h \
  ../common/progressmonitor.h \
  nodetype.h \
  ../common/commondefs.h \
  customfilter.h \
  node.h \
  ../common/filereader.h \
  ../common/exception.h \
  ../common/commonutil.h \
  ../common/bigdecimal.h \
  ../common/expression.h
$O/dataflowmanager.obj: dataflowmanager.cc \
  ../common/commonutil.h \
  ../common/bigdecimal.h \
  ../common/exception.h \
  node.h \
  ../common/filereader.h \
  dataflowmanager.h \
  nodetype.h \
  ../common/progressmonitor.h \
  ../common/commondefs.h \
  commonnodes.h \
  channel.h \
  scavedefs.h
$O/datasorter.obj: datasorter.cc \
  enumtype.h \
  ../common/exception.h \
  fields.h \
  datasorter.h \
  statistics.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  ../common/rwlock.h \
  scaveutils.h \
  scavedefs.h \
  ../common/stringutil.h \
  ../common/patternmatcher.h \
  ../common/commondefs.h \
  resultfilemanager.h \
  idlist.h
$O/diffquot.obj: diffquot.cc \
  diffquot.h \
  scavedefs.h \
  commonnodes.h \
  channel.h \
  nodetype.h \
  ../common/progressmonitor.h \
  dataflowmanager.h \
  ../common/commondefs.h \
  ../common/filereader.h \
  node.h \
  ../common/exception.h \
  ../common/commonutil.h \
  ../common/bigdecimal.h
$O/enumtype.obj: enumtype.cc \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  ../common/exception.h \
  enumtype.h \
  ../common/stringtokenizer.h \
  ../common/commondefs.h \
  scaveutils.h \
  scavedefs.h
$O/export.obj: export.cc \
  resultfilemanager.h \
  idlist.h \
  ../common/commondefs.h \
  export.h \
  ../common/patternmatcher.h \
  scaveutils.h \
  scavedefs.h \
  ../common/stringutil.h \
  datasorter.h \
  ../common/commonutil.h \
  ../common/rwlock.h \
  statistics.h \
  xyarray.h \
  ../common/bigdecimal.h \
  ../common/opp_ctype.h \
  fields.h \
  enumtype.h \
  ../common/exception.h
$O/fields.obj: fields.cc \
  fields.h \
  enumtype.h \
  ../common/exception.h \
  ../common/rwlock.h \
  ../common/commonutil.h \
  statistics.h \
  ../common/bigdecimal.h \
  ../common/patternmatcher.h \
  scaveutils.h \
  ../common/stringutil.h \
  scavedefs.h \
  resultfilemanager.h \
  idlist.h \
  ../common/commondefs.h
$O/filewriter.obj: filewriter.cc \
  ../common/commondefs.h \
  nodetype.h \
  ../common/progressmonitor.h \
  dataflowmanager.h \
  channel.h \
  filewriter.h \
  commonnodes.h \
  scavedefs.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  ../common/exception.h \
  ../common/filereader.h \
  node.h
$O/filternodes.obj: filternodes.cc \
  node.h \
  ../common/filereader.h \
  filternodes.h \
  ../common/exception.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  scavedefs.h \
  ../common/stringutil.h \
  channel.h \
  commonnodes.h \
  ../common/commondefs.h \
  dataflowmanager.h \
  nodetype.h \
  ../common/progressmonitor.h
$O/idlist.obj: idlist.cc \
  ../common/commondefs.h \
  resultfilemanager.h \
  idlist.h \
  scaveutils.h \
  ../common/stringutil.h \
  scavedefs.h \
  statistics.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  ../common/rwlock.h \
  enumtype.h \
  ../common/exception.h
$O/indexedvectorfile.obj: indexedvectorfile.cc \
  ../common/linetokenizer.h \
  scavedefs.h \
  ../common/stringutil.h \
  scaveutils.h \
  channel.h \
  idlist.h \
  nodetype.h \
  ../common/progressmonitor.h \
  resultfilemanager.h \
  dataflowmanager.h \
  ../common/commondefs.h \
  indexedvectorfile.h \
  ../common/filereader.h \
  node.h \
  indexfile.h \
  ../common/exception.h \
  enumtype.h \
  ../common/commonutil.h \
  ../common/rwlock.h \
  ../common/bigdecimal.h \
  statistics.h
$O/indexedvectorfilereader.obj: indexedvectorfilereader.cc \
  commonnodes.h \
  channel.h \
  nodetype.h \
  ../common/progressmonitor.h \
  idlist.h \
  dataflowmanager.h \
  resultfilemanager.h \
  ../common/commondefs.h \
  ../common/linetokenizer.h \
  scavedefs.h \
  indexedvectorfilereader.h \
  scaveutils.h \
  ../common/rwlock.h \
  ../common/commonutil.h \
  ../common/bigdecimal.h \
  statistics.h \
  ../common/filereader.h \
  node.h \
  indexfile.h \
  ../common/opp_ctype.h \
  vectorfilereader.h \
  ../common/exception.h \
  enumtype.h
$O/indexedvectorfilereader2.obj: indexedvectorfilereader2.cc \
  ../common/linetokenizer.h \
  scavedefs.h \
  scaveutils.h \
  indexedvectorfilereader2.h \
  channel.h \
  commonnodes.h \
  ../common/commondefs.h \
  ../common/progressmonitor.h \
  nodetype.h \
  idlist.h \
  resultfilemanager.h \
  dataflowmanager.h \
  ../common/filereader.h \
  node.h \
  vectorfilereader.h \
  ../common/exception.h \
  enumtype.h \
  indexfile.h \
  ../common/opp_ctype.h \
  ../common/bigdecimal.h \
  statistics.h \
  ../common/commonutil.h \
  ../common/rwlock.h
$O/indexfile.obj: indexfile.cc \
  scavedefs.h \
  scaveexception.h \
  ../common/linetokenizer.h \
  ../common/stringutil.h \
  scaveutils.h \
  ../common/commondefs.h \
  ../common/exception.h \
  indexfile.h \
  ../common/filereader.h \
  ../common/bigdecimal.h \
  statistics.h \
  ../common/commonutil.h
$O/mergernodes.obj: mergernodes.cc \
  scaveutils.h \
  scavedefs.h \
  mergernodes.h \
  commonnodes.h \
  channel.h \
  dataflowmanager.h \
  nodetype.h \
  ../common/progressmonitor.h \
  ../common/commondefs.h \
  node.h \
  ../common/filereader.h \
  ../common/exception.h \
  ../common/commonutil.h \
  ../common/bigdecimal.h
$O/nodetype.obj: nodetype.cc \
  node.h \
  ../common/exception.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  scavedefs.h \
  channel.h \
  ../common/commondefs.h \
  dataflowmanager.h \
  ../common/progressmonitor.h \
  nodetype.h
$O/nodetyperegistry.obj: nodetyperegistry.cc \
  customfilter.h \
  enumtype.h \
  ../common/exception.h \
  teenode.h \
  indexfile.h \
  ../common/stringtokenizer.h \
  ../common/bigdecimal.h \
  xyarray.h \
  statistics.h \
  ../common/rwlock.h \
  ../common/commonutil.h \
  xyplotnode.h \
  ../common/linetokenizer.h \
  scaveutils.h \
  slidingwinavg.h \
  channel.h \
  ../common/stringpool.h \
  ../common/progressmonitor.h \
  idlist.h \
  resultfilemanager.h \
  dataflowmanager.h \
  windowavg.h \
  ../common/filereader.h \
  node.h \
  filternodes.h \
  vectorfilewriter.h \
  nodetyperegistry.h \
  vectorfilereader.h \
  arraybuilder.h \
  stddev.h \
  ../common/expression.h \
  ../common/stringutil.h \
  scavedefs.h \
  indexedvectorfilereader.h \
  mergernodes.h \
  diffquot.h \
  indexedvectorfilereader2.h \
  filewriter.h \
  commonnodes.h \
  ../common/commondefs.h \
  indexedvectorfile.h \
  nodetype.h
$O/octaveexport.obj: octaveexport.cc \
  ../common/exception.h \
  ../common/bigdecimal.h \
  xyarray.h \
  ../common/opp_ctype.h \
  scavedefs.h \
  ../common/commondefs.h \
  octaveexport.h
$O/resultfilemanager.obj: resultfilemanager.cc \
  ../common/linetokenizer.h \
  scaveutils.h \
  idlist.h \
  resultfilemanager.h \
  enumtype.h \
  ../common/exception.h \
  indexfile.h \
  ../common/stringtokenizer.h \
  ../common/bigdecimal.h \
  statistics.h \
  ../common/commonutil.h \
  ../common/rwlock.h \
  scavedefs.h \
  ../common/stringutil.h \
  scaveexception.h \
  ../common/patternmatcher.h \
  ../common/fileutil.h \
  ../common/commondefs.h \
  ../common/filereader.h \
  ../common/matchexpression.h \
  ../common/opp_ctype.h
$O/scaveexception.obj: scaveexception.cc \
  scavedefs.h \
  scaveexception.h \
  ../common/commondefs.h \
  ../common/exception.h \
  ../common/bigdecimal.h
$O/scavetool.obj: scavetool.cc \
  ../common/linetokenizer.h \
  scaveutils.h \
  ../common/progressmonitor.h \
  idlist.h \
  resultfilemanager.h \
  dataflowmanager.h \
  channel.h \
  ../common/stringtokenizer.h \
  enumtype.h \
  ../common/exception.h \
  vectorfileindexer.h \
  ../common/rwlock.h \
  ../common/commonutil.h \
  xyarray.h \
  ../common/bigdecimal.h \
  statistics.h \
  export.h \
  ../common/patternmatcher.h \
  ../common/stringutil.h \
  scavedefs.h \
  nodetype.h \
  ../common/commondefs.h \
  commonnodes.h \
  filewriter.h \
  fields.h \
  arraybuilder.h \
  ../common/ver.h \
  nodetyperegistry.h \
  vectorfilereader.h \
  filternodes.h \
  vectorfilewriter.h \
  ../common/filereader.h \
  node.h \
  datasorter.h
$O/scaveutils.obj: scaveutils.cc \
  ../common/commondefs.h \
  scavedefs.h \
  scaveutils.h \
  ../common/commonutil.h \
  ../common/bigdecimal.h \
  ../common/exception.h
$O/slidingwinavg.obj: slidingwinavg.cc \
  node.h \
  ../common/filereader.h \
  scavedefs.h \
  ../common/commondefs.h \
  nodetype.h \
  commonnodes.h \
  ../common/exception.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  slidingwinavg.h \
  dataflowmanager.h \
  ../common/progressmonitor.h \
  channel.h
$O/stddev.obj: stddev.cc \
  scavedefs.h \
  nodetype.h \
  ../common/commondefs.h \
  commonnodes.h \
  node.h \
  ../common/filereader.h \
  stddev.h \
  scaveutils.h \
  dataflowmanager.h \
  ../common/progressmonitor.h \
  channel.h \
  ../common/exception.h \
  ../common/commonutil.h \
  ../common/bigdecimal.h \
  xyarray.h
$O/teenode.obj: teenode.cc \
  channel.h \
  ../common/progressmonitor.h \
  dataflowmanager.h \
  teenode.h \
  ../common/exception.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  scavedefs.h \
  commonnodes.h \
  ../common/commondefs.h \
  nodetype.h \
  ../common/filereader.h \
  node.h
$O/vectorfileindexer.obj: vectorfileindexer.cc \
  vectorfileindexer.h \
  indexfile.h \
  enumtype.h \
  ../common/exception.h \
  ../common/commonutil.h \
  ../common/rwlock.h \
  ../common/bigdecimal.h \
  statistics.h \
  ../common/linetokenizer.h \
  scaveutils.h \
  channel.h \
  idlist.h \
  ../common/progressmonitor.h \
  dataflowmanager.h \
  resultfilemanager.h \
  ../common/filereader.h \
  node.h \
  ../common/opp_ctype.h \
  nodetyperegistry.h \
  scavedefs.h \
  scaveexception.h \
  ../common/stringutil.h \
  nodetype.h \
  ../common/commondefs.h \
  indexedvectorfile.h
$O/vectorfilereader.obj: vectorfilereader.cc \
  statistics.h \
  ../common/bigdecimal.h \
  ../common/rwlock.h \
  ../common/commonutil.h \
  enumtype.h \
  ../common/exception.h \
  channel.h \
  dataflowmanager.h \
  resultfilemanager.h \
  idlist.h \
  ../common/progressmonitor.h \
  scaveutils.h \
  ../common/linetokenizer.h \
  node.h \
  ../common/filereader.h \
  vectorfilereader.h \
  ../common/opp_ctype.h \
  commonnodes.h \
  ../common/commondefs.h \
  nodetype.h \
  scavedefs.h \
  scaveexception.h
$O/vectorfilewriter.obj: vectorfilewriter.cc \
  vectorfilewriter.h \
  node.h \
  nodetype.h \
  ../common/commondefs.h \
  ../common/stringutil.h \
  scavedefs.h \
  ../common/commonutil.h \
  ../common/rwlock.h \
  statistics.h \
  ../common/bigdecimal.h \
  ../common/exception.h \
  enumtype.h \
  channel.h \
  resultfilemanager.h \
  dataflowmanager.h \
  ../common/progressmonitor.h \
  idlist.h \
  scaveutils.h
$O/windowavg.obj: windowavg.cc \
  node.h \
  ../common/filereader.h \
  commonnodes.h \
  ../common/commondefs.h \
  nodetype.h \
  scavedefs.h \
  ../common/bigdecimal.h \
  ../common/commonutil.h \
  ../common/exception.h \
  channel.h \
  dataflowmanager.h \
  windowavg.h \
  ../common/progressmonitor.h \
  scaveutils.h
$O/xyarray.obj: xyarray.cc \
  ../common/bigdecimal.h \
  xyarray.h \
  ../common/exception.h \
  ../common/commondefs.h \
  scavedefs.h
$O/xyplotnode.obj: xyplotnode.cc \
  scavedefs.h \
  commonnodes.h \
  nodetype.h \
  ../common/commondefs.h \
  ../common/filereader.h \
  node.h \
  channel.h \
  ../common/progressmonitor.h \
  dataflowmanager.h \
  ../common/exception.h \
  ../common/commonutil.h \
  ../common/bigdecimal.h \
  xyplotnode.h
