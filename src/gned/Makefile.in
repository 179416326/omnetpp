#
# Definitions to be customized by 'configure'
#
CXX=@CXX@
CC=@CC@
YACC=@YACC@
LEX=@LEX@
MAKEDEPEND=@MAKEDEPEND@

CFLAGS=@CFLAGS@
LDFLAGS=@LDFLAGS@
EXE_SUFFIX=@EXE_SUFFIX@

OMNETPP_BITMAP_PATH=@OMNETPP_BITMAP_PATH@
OMNETPP_BIN_DIR=@OMNETPP_BIN_DIR@

TK_CFLAGS=@TK_CFLAGS@
TK_LIBS=@TK_LIBS@
SYS_LIBS=@SYS_LIBS@

# The following is either '-e' (embedded Tcl code) or '' (no embedding)
GNED_EMBED_SUFFIX=@GNED_EMBED_SUFFIX@

#
# Local definitions
#
COPTS=$(CFLAGS) $(TK_CFLAGS)

OMNETPP_GNED_DIR=@OMNETPP_GNED_DIR@

OBJS = gned$(GNED_EMBED_SUFFIX).o tklib.o arrow.o ebnf.tab.o lex.yy.o parsened.o nedfile.o

#
# Targets
#
default: @GNED_IF_POSSIBLE@

gned : $(OBJS)
	$(CC) $(LDFLAGS) $(OBJS) $(TK_LIBS) $(SYS_LIBS) -o gned
	../utils/install-prog gned $(OMNETPP_BIN_DIR)

gned.o : gned.cc
	$(CXX) -c $(COPTS) -DOMNETPP_GNED_DIR="\"$(OMNETPP_GNED_DIR)\"" -DOMNETPP_BITMAP_PATH="\"$(OMNETPP_BITMAP_PATH)\"" gned.cc

gned-e.o : gned.cc tclcode.cc
	$(CXX) -c $(COPTS) -DOMNETPP_BITMAP_PATH="\"$(OMNETPP_BITMAP_PATH)\"" gned.cc -o gned-e.o

tklib.o : tklib.cc
	$(CXX) -c $(COPTS) tklib.cc

arrow.o: arrow.cc
	$(CXX) -c $(COPTS) arrow.cc

parsened.o: parsened.cc
	$(CXX) -c $(COPTS) parsened.cc

nedfile.o: nedfile.cc
	$(CXX) -c $(COPTS) nedfile.cc

lex.yy.o: lex.yy.c
	# FIXME: true64's cxx insists on .cc suffix for C++ files -- any better solution than below?
	if [ "$(CXX)" = "cxx" ]; then \
		cp lex.yy.c lex.yy.cc && $(CXX) -c $(COPTS) lex.yy.cc; \
	else \
		$(CXX) -c $(COPTS) lex.yy.c; \
	fi

ebnf.tab.o: ebnf.tab.c
	# FIXME: true64's cxx insists on .cc suffix for C++ files -- any better solution than below?
	if [ "$(CXX)" = "cxx" ]; then \
		cp ebnf.tab.c ebnf.tab.cc && $(CXX) -c $(COPTS) -DCXX ebnf.tab.cc; \
	else \
		$(CXX) -c $(COPTS) ebnf.tab.c; \
	fi

ebnf.tab.h: ebnf.y
	$(YACC) -b ebnf -d ebnf.y

ebnf.tab.c: ebnf.y
	$(YACC) -b ebnf -d ebnf.y

lex.yy.c: ebnf.lex
	$(LEX) ebnf.lex

tclcode.cc: *.tcl
	../utils/tcl2c tclcode.cc *.tcl

missing-library:
	@ echo '  *** No Tk installation found -- skipping GNED'

depend:
	$(MAKEDEPEND) -I. -- *.c *.cc
	$(MAKEDEPEND) -I. -fMakefile.in -- *.c *.cc

clean:
	rm -f tclcode.cc *.o lex.yy.c ebnf.tab.c ebnf.tab.h gned$(EXE_SUFFIX)
	rm -f ebnf.tab.cc lex.yy.cc

# DO NOT DELETE THIS LINE -- make depend depends on it.

ebnf.tab.o: ebnf.h ebnfcfg.h parsened.h nedfile.h
lex.yy.o: ebnf.h ebnf.tab.h ebnfcfg.h parsened.h
arrow.o: arrow.h
gned.o: arrow.h parsened.h ebnf.h tklib.h
nedfile.o: nedfile.h parsened.h ebnf.h
parsened.o: parsened.h ebnf.h nedfile.h tklib.h
tklib.o: tklib.h
