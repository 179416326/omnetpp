#! /usr/bin/perl
#
# prephtml - tidy up usman.html (generated by MS Internet Assistant from
#            usman.doc). Add page heading, table of contents etc.
#

$fname = $ARGV[0];

#
# general template for our output HTML pages; real contents will go to __BODY__
#
$template = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
   <TITLE>OMNeT++ - Manual</TITLE>
   <META NAME="Author" CONTENT="Andras Varga">
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFE8" LINK="#0000EE" VLINK="#551A8B" ALINK="#FF0000">

<P><FONT COLOR="#FF0000"><B><FONT SIZE=+4>OMNeT++ </FONT></B>
<I><FONT SIZE=+1>Discrete Event Simulation System</FONT></I></FONT></P>

__BODY__

</BODY>
</HTML>
';

#
# read file into variable
#
open( htmlf, $fname ) || die "cannot open $fname";
read( htmlf, $html, 1000000 ) || die "cannot read $fname";

#
# kill unwanted formatting
#
$html =~ s/ SIZE=2//g;
$html =~ s/ FACE="[^"]*"//g;

#
# kill html header, title page, bad table of contents etc.
#
$html =~ s/^(.*?)\<H1\>/<H1>/s;
$html =~ s/\<\/BODY\>.*$//s;

#
# add horiz bar before each H1 heading 
#
$html =~ s/\<H1\>/<HR><H1>/g;

#
# convert filenames in <IMG SRC="IMG00010.GIF"> tags to lowercase
#
$html =~ s/\"IMG([0-9]*)\.GIF\"/\"img$1.gif\"/g;

#
# collect heading info from document
#
$scrap = $html;
$i = 0;
while ($scrap =~ s/\<H([0-9])\>(.*?)\<\/H[0-9]\>//s) 
{
      $level[$i] = $1;
      $2 =~ m/\<A NAME\=\"(.*?)\"\>(.*)\<\/A\>/s;
      $label[$i] = $1;
      $title[$i] = $2;
      $i++;
}
$n = $i;

#
# create 'topics' table
#
$topics = "<H1>Topics</H1>\n";
for ($i=0; $i<$n; $i++) 
{
      if ($level[$i]==1) 
      {
           # $entry = "<B><A HREF=\"#$label[$i]\">$title[$i]</A></B><BR>";
           $entry = "<B><A HREF=\"#TOC_$i\">$title[$i]</A></B><BR>";
           $topics = "$topics$entry\n";
      }
}

#
# create table of contents
#
$toc = "<H1>Detailed Table of Contents</H1>\n";
for ($i=0; $i<$n; $i++) 
{
      $entry = "<A NAME=\"TOC_$i\"></A><A HREF=\"#$label[$i]\">$title[$i]</A>";
      for ($j=0; $j<$level[$i]; $j++) {$entry = "&nbsp;&nbsp;$entry";}
      if ($level[$i]==1)    {$entry = "<BR><FONT SIZE=+1><B>$entry</B></FONT>";}
      elsif ($level[$i]==2) {$entry = "<B>$entry</B>";}
      $toc = "$toc$entry<BR>\n";
}

#
# put together HTML page 
#
$new_html = $template;
$new_html =~ s/__BODY__/<H1><B>User Manual<\/B><\/H1>$topics<HR>$toc$html/;

printf "%s", $new_html;

