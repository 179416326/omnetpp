#!/bin/env python3

import os
import sys
import argparse
import xml.etree.ElementTree as ET
import matplotlib.pyplot as plt


_real_show = plt.show

def _fake_show(*args, **kwargs):
    global _show_called
    _real_show(*args, **kwargs)
    _show_called = True

plt.show = _fake_show


import numpy as np
import pandas as pd
import results
import chart


def error(message):
    print("ERROR: " + message)
    sys.exit(1)


class Chart:
    def __init__(self, type=str(), name=str(), script=str(), properties=dict()):
        self.type = type
        self.name = name
        self.script = script
        self.properties = properties

class Analysis:
    def __init__(self, inputs=list(), charts=list()):
        self.inputs = inputs
        self.charts = charts


def load_anf_file(anf_file_name):
    analysis = ET.parse(anf_file_name).getroot()

    version = analysis.get('version')

    if version != "2":
        error("Unsupported analysis file version: \"{}\" (only \"2\" is supported).".format(version))

    inputs = [i.get('pattern') for i in analysis.findall("inputs/input")]

    charts = [
            Chart(c.get('type'), c.get('name'), c.get('script'),
                { p.get('name') : p.get('value') for p in c.findall('property') })
            for c in analysis.findall("charts/chart")]

    return Analysis(inputs, charts)


def print_analysis_info(anf_file, analysis):
    print('\nThe "{}" file contains {} charts:\n'.format(anf_file, len(analysis.charts)))
    for i, c in enumerate(analysis.charts):
        print('\t{}.\t"{}"\t({})'.format(i, c.name, c.type))

    print("\nAnd {} inputs:\n".format(len(analysis.inputs)))
    for i, inp in enumerate(analysis.inputs):
        print('\t"{}"'.format(inp))


def run_chart(c):

    chart.name = c.name
    chart.properties = c.properties

    script = c.script

    global _show_called
    _show_called = False

    # print(script)
    exec(script)

    if not _show_called:
        # print("calling explicit plt.show()")
        plt.show()


if __name__ == "__main__":

    parser = argparse.ArgumentParser(description='Tool for working with OMNeT++ analysis files.')
    parser.add_argument('anf_file', type=str, nargs=1, help='The Analysis (.anf) file')
    parser.add_argument('-i', metavar='chart_index', type=int, nargs=1, help='The index of the chart to run (conflicts with -n)')
    parser.add_argument('-n', metavar='chart_name', type=str, nargs=1, help='The name of the chart to run (conflicts with -i, the first chart is selected when ambiguous)')

    args = parser.parse_args()

    if args.i and args.n:
        error("Do not use -i and -n together.")


    analysis = load_anf_file(args.anf_file[0])

    if False: # debug output
        import json
        print(json.dumps(analysis, default=lambda obj: vars(
            obj), indent=4, separators=(',', ': ')))


        # results.wd = "/home/attila/projects/omnetpp/samples" # os.path.dirname(os.path.abspath(args.anf_file[0]))
    results.inputs = analysis.inputs

    if not args.i and not args.n:
        print_analysis_info(args.anf_file[0], analysis)
    elif args.i:
        run_chart(analysis.charts[args.i[0]])
    elif args.n:

        ch = None
        for c in analysis.charts:
            if c.name == args.n[0]:
                ch = c
                break

        if ch:
            run_chart(ch)
        else:
            error('No chart named "{}".'.format(args.n[0]))
